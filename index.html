<!DOCTYPE html>
<html lang="ne">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Poison & Save: Perfect Fit</title>
    <style>
        :root { --primary: #780000; --bg: #fdf0d5; --accent: #003049; --gold: #fcbf49; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; touch-action: manipulation; }
        
        body { 
            font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 0; 
            display: flex; justify-content: center; align-items: center; 
            height: 100vh; width: 100vw; overflow: hidden; 
        }

        #game-container { 
            width: 95%; max-width: 400px; height: 90vh; 
            background: white; padding: 15px; border-radius: 20px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); 
            display: flex; flex-direction: column; position: relative;
        }

        .scoreboard { 
            display: flex; justify-content: space-between; align-items: center;
            background: var(--accent); color: white; padding: 12px; 
            border-radius: 12px; margin-bottom: 10px; font-weight: bold; font-size: 13px;
        }

        .status-box { 
            background: #f8f9fa; padding: 10px; border-radius: 10px; text-align: center; 
            margin-bottom: 10px; font-weight: bold; color: var(--primary); border: 1px solid #eee;
        }

        .grid { 
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; 
            flex-grow: 1; align-content: center;
        }

        .candy { 
            aspect-ratio: 1/1; font-size: 40px; background: #fff; 
            border: 2px solid #f0f0f0; border-radius: 15px; 
            display: flex; align-items: center; justify-content: center; cursor: pointer;
        }
        .removed { visibility: hidden; opacity: 0; }

        /* Overlays */
        .overlay { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            display: flex; flex-direction: column; align-items: center; 
            justify-content: center; z-index: 500; text-align: center; 
            border-radius: 20px; padding: 20px;
        }
        #round-overlay { background: rgba(0, 48, 73, 0.95); color: white; }
        #final-overlay { background: var(--primary); color: white; }

        .setup-screen { text-align: center; width: 100%; }
        input { 
            width: 100%; padding: 15px; margin: 10px 0; border: 2px solid #ddd; 
            border-radius: 12px; font-size: 16px; text-align: center;
        }
        .btn { 
            background: var(--primary); color: white; border: none; padding: 15px; 
            border-radius: 12px; width: 100%; font-weight: bold; cursor: pointer; font-size: 16px;
        }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="game-container">
        <div id="setup-section" class="setup-screen">
            <h2 style="color:var(--primary)">üç´ Poison & Save</h2>
            <p style="font-size: 12px; color: #666;">Enter name & room to join</p>
            <input type="text" id="playerName" placeholder="Tapaiko Naam">
            <input type="text" id="roomInput" placeholder="Room ID (nepal123)">
            <button class="btn" onclick="joinGame()">KHELMA JOIN HUNUOS</button>
        </div>

        <div id="game-section" class="hidden" style="height: 100%; display: flex; flex-direction: column;">
            <div id="round-overlay" class="overlay hidden">
                <h2 style="color: var(--gold); margin: 0;">ROUND OVER!</h2>
                <div id="round-winner-text" style="font-size: 22px; margin: 10px 0;">Name Win</div>
                <p style="font-size: 12px;">Next round starting...</p>
            </div>

            <div id="final-overlay" class="overlay hidden">
                <h1 style="font-size: 60px; margin: 0;">üëë</h1>
                <p>ULTIMATE CHAMPION</p>
                <div id="final-winner-text" style="font-size: 28px; font-weight: bold; color: var(--gold);">PLAYER</div>
                <p id="final-score-text" style="font-size: 14px;"></p>
                <button class="btn" style="background:white; color:var(--primary); width:150px; margin-top:20px;" onclick="location.reload()">REPLAY</button>
            </div>

            <div class="scoreboard">
                <div id="p1-info">P1: 0</div>
                <div id="round-info">Round: 1/11</div>
                <div id="p2-info">P2: 0</div>
            </div>

            <div class="status-box" id="status-text">Wait...</div>
            <div id="grid" class="grid"></div>
            
            <button onclick="location.reload()" style="margin-top:10px; background:none; border:none; color:gray; font-size:11px;">EXIT ROOM</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // Firebase Config halnuhos
        const firebaseConfig = { 
            apiKey: "AIzaSyDT6QJyFjZhjrCd-7d00IxFSlWqOBp2xY8",
  authDomain: "poison-and-save.firebaseapp.com",
  databaseURL: "https://poison-and-save-default-rtdb.firebaseio.com",
  projectId: "poison-and-save",
  storageBucket: "poison-and-save.firebasestorage.app",
  messagingSenderId: "475847800468",
  appId: "1:475847800468:web:93605c30c6c6c775e2a681",
  measurementId: "G-VR6WKKB1DV"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        let roomID, myRole, myName, gameData = {};

        window.joinGame = () => {
            roomID = document.getElementById('roomInput').value.trim().toLowerCase();
            myName = document.getElementById('playerName').value.trim();
            if(!roomID || !myName) return alert("Details bharnuhos!");

            const roomRef = ref(db, 'rooms/' + roomID);
            onValue(roomRef, (snapshot) => {
                const data = snapshot.val();
                if (myRole && !data) { location.reload(); return; }

                if (!data) {
                    myRole = "p1";
                    set(roomRef, { state: "selecting", turn: "p1", round: 1, p1_name: myName, p1_score: 0, p2_score: 0 });
                } else if (!myRole) {
                    myRole = "p2";
                    update(roomRef, { p2_name: myName, state: "selecting" });
                }
                gameData = data || {};
                renderUI();
            });

            document.getElementById('setup-section').classList.add('hidden');
            document.getElementById('game-section').classList.remove('hidden');
            createGrid();
        };

        function createGrid() {
            const grid = document.getElementById('grid'); grid.innerHTML = "";
            for (let i = 0; i < 12; i++) {
                let div = document.createElement('div');
                div.className = 'candy'; div.id = `candy-${i}`; div.innerHTML = "üç´";
                div.onclick = () => handleClick(i);
                grid.appendChild(div);
            }
        }

        function handleClick(index) {
            const roomRef = ref(db, 'rooms/' + roomID);
            if (gameData.state === "selecting") {
                if (myRole === "p1" && gameData.p1_poison === undefined) update(roomRef, { p1_poison: index });
                if (myRole === "p2" && gameData.p2_poison === undefined) update(roomRef, { p2_poison: index });
            } 
            else if (gameData.state === "playing" && gameData.turn === myRole) {
                if (gameData[`rem_${index}`]) return;
                if (index === gameData.p1_poison || index === gameData.p2_poison) {
                    handleVictory(myRole === "p1" ? "p2" : "p1");
                } else {
                    update(roomRef, { turn: (myRole === "p1" ? "p2" : "p1"), [`rem_${index}`]: true });
                }
            }
        }

        function handleVictory(winnerRole) {
            const roomRef = ref(db, 'rooms/' + roomID);
            const nextR = (gameData.round || 1) + 1;
            const newScore = (gameData[winnerRole + "_score"] || 0) + 1;
            const roundWinnerName = gameData[winnerRole + "_name"];

            update(roomRef, { state: "round_ended", last_round_winner: roundWinnerName, [winnerRole + "_score"]: newScore });

            setTimeout(() => {
                if (nextR > 11) {
                    // Logic: Point dherai hune lai Champion banaune
                    let finalWinner = "";
                    let s1 = (winnerRole === 'p1' ? newScore : gameData.p1_score);
                    let s2 = (winnerRole === 'p2' ? newScore : gameData.p2_score);
                    
                    if (s1 > s2) finalWinner = gameData.p1_name;
                    else if (s2 > s1) finalWinner = gameData.p2_name;
                    else finalWinner = "TIE! BOTH";

                    update(roomRef, { state: "final_ended", final_winner: finalWinner, f_score: `${s1} - ${s2}` });
                } else {
                    let reset = { state: "selecting", turn: "p1", round: nextR, p1_poison: null, p2_poison: null };
                    for(let i=0; i<12; i++) reset[`rem_${i}`] = null;
                    update(roomRef, reset);
                }
            }, 2500);
        }

        function renderUI() {
            if (!gameData.state) return;
            document.getElementById('p1-info').innerText = `${gameData.p1_name || 'P1'}: ${gameData.p1_score}`;
            document.getElementById('p2-info').innerText = `${gameData.p2_name || 'P2'}: ${gameData.p2_score}`;
            document.getElementById('round-info').innerText = `Round: ${gameData.round}/11`;

            const roundOverlay = document.getElementById('round-overlay');
            const finalOverlay = document.getElementById('final-overlay');

            if (gameData.state === "round_ended") {
                roundOverlay.classList.remove('hidden');
                document.getElementById('round-winner-text').innerText = "Round Over! " + gameData.last_round_winner + " Win";
            } else { roundOverlay.classList.add('hidden'); }

            if (gameData.state === "final_ended") {
                finalOverlay.classList.remove('hidden');
                document.getElementById('final-winner-text').innerText = gameData.final_winner;
                document.getElementById('final-score-text').innerText = "Final Score: " + gameData.f_score;
            }

            if (gameData.state === "selecting" && gameData.p1_poison !== undefined && gameData.p2_poison !== undefined) {
                update(ref(db, 'rooms/' + roomID), { state: "playing" });
            }

            for (let i = 0; i < 12; i++) {
                const el = document.getElementById(`candy-${i}`);
                if (gameData[`rem_${i}`]) el.classList.add('removed');
                else el.classList.remove('removed');
            }

            const statusText = document.getElementById('status-text');
            if (gameData.state === "selecting") {
                const myPoisoned = (myRole === "p1" ? gameData.p1_poison : gameData.p2_poison) !== undefined;
                statusText.innerText = (!myPoisoned) ? "SET YOUR POISON üíÄ" : "WAITING FOR OPPONENT...";
            } else if (gameData.state === "playing") {
                statusText.innerText = (gameData.turn === myRole) ? "üëâ YOUR TURN!" : "WAITING...";
            }
        }
    </script>
</body>
</html>
